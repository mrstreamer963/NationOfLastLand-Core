<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Example WASM</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #canvasContainer {
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }
        #output {
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <h1>Example WASM Module</h1>

    <div class="container">
        <h2>Core Info</h2>
        <button onclick="showCoreInfo()">Get Core Info</button>
    </div>

    <div class="container">
        <h2>Async Example</h2>
        <button onclick="runAsyncExample()">Run Async</button>
    </div>

    <div class="container">
        <h2>Pixi.js Rendering</h2>
        <button onclick="initRender()">Init World</button>
        <button onclick="startAnimation()" id="startBtn">Start Animation</button>
        <button onclick="stopAnimation()" id="stopBtn" disabled>Stop Animation</button>
        <div id="canvasContainer"></div>
    </div>

    <div id="output">
        <strong>Output:</strong><br>
        <div id="result"></div>
    </div>

    <script type="module">
        import init, { get_core_info, async_example, get_world_data, update_world } from './pkg/example_wasm.js';

        let pixiApp = null;
        let animationFrame = null;
        let lastTime = 0;
        let isRunning = false;
        let canvas = null;
        let ctx = null;

        async function run() {
            await init();
            log('WASM module loaded successfully!');
        }

        window.showCoreInfo = function() {
            const info = get_core_info();
            log(`Core Info: ${info}`);
        };

        window.runAsyncExample = async function() {
            try {
                const result = await async_example();
                log(`Async Result: ${result}`);
            } catch (error) {
                log(`Async Error: ${error}`);
            }
        };

        window.initRender = function() {
            console.log('Starting initRender');
            const container = document.getElementById('canvasContainer');
            container.innerHTML = ''; // Clear previous canvas

            // Create plain HTML canvas
            canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            container.appendChild(canvas);
            ctx = canvas.getContext('2d');
            console.log('Canvas created and added');

            // Initial render
            draw();

            log('World initialized');
        };

        function draw() {
            if (!ctx) return;

            // Clear background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 800, 600);

            // Add test text
            ctx.fillStyle = 'black';
            ctx.font = '16px Arial';
            ctx.fillText('Canvas2D is working!', 10, 30);

            // Get world data from WASM
            const worldDataJson = get_world_data();
            console.log('worldDataJson:', worldDataJson);

            let worldData;
            try {
                worldData = JSON.parse(worldDataJson);
                console.log('worldData parsed:', worldData);
            } catch (error) {
                console.error('JSON parse error:', error);
                return;
            }

            // Display time
            if (worldData.state && worldData.state.time !== undefined) {
                ctx.fillText(`Time: ${worldData.state.time.toFixed(2)}`, 10, 50);
            }

            // Scale factor for positions
            const scale = 50;

            // Draw units based on type
            if (worldData.units && Array.isArray(worldData.units)) {
                worldData.units.forEach((unit, index) => {
                    console.log(`Drawing unit ${index} at pos:`, unit.Pos, 'type:', unit.EntityType);
                    if (!unit.Pos || typeof unit.Pos.x !== 'number' || typeof unit.Pos.y !== 'number') {
                        console.log(`Skipping unit ${index} due to invalid position data`);
                        return;
                    }
                    const x = unit.Pos.x * scale;
                    const y = unit.Pos.y * scale;
                    if (unit.EntityType === 'Vehicle') {
                        ctx.beginPath();
                        ctx.arc(x, y, 15, 0, 2 * Math.PI);
                        ctx.fillStyle = 'blue';
                        ctx.fill();
                        ctx.strokeStyle = 'black';
                        ctx.stroke();
                        console.log(`Vehicle drawn at: ${x}, ${y}`);
                    } else if (unit.EntityType === 'Waste' || unit.EntityType === 'Trash') {
                        ctx.fillStyle = 'red';
                        ctx.fillRect(x, y, 20, 20);
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x, y, 20, 20);
                        console.log(`Waste drawn at: ${x}, ${y}`);
                    }
                });
            }

            console.log('Drawing completed');
        }

        function animate(currentTime) {
            if (!isRunning) return;

            const deltaMs = currentTime - lastTime;
            lastTime = currentTime;

            // Update world in WASM
            update_world(deltaMs);

            // Redraw
            draw();

            // Schedule next frame
            animationFrame = requestAnimationFrame(animate);
        }

        window.startAnimation = function() {
            if (isRunning) return;

            isRunning = true;
            lastTime = performance.now();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            // Start animation loop
            animationFrame = requestAnimationFrame(animate);

            log('Animation started');
        };

        window.stopAnimation = function() {
            if (!isRunning) return;

            isRunning = false;
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;

            log('Animation stopped');
        };

        function log(message) {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            resultDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            console.log(message);
        }

        run();
    </script>
</body>
</html>
